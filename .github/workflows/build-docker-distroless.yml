name: build-docker-distroless

permissions:
  contents: read
  packages: write

on:
  workflow_call:
    inputs:
      binary-artifact:
        description: Artifact name containing the pkg executables
        required: false
        default: pkg-binaries
        type: string
      push:
        description: Whether to push the built images
        required: false
        default: false
        type: boolean
      platforms:
        description: Target platforms
        required: false
        default: linux/amd64
        type: string
      flood-tags:
        description: Docker tags for the flood distroless image (newline separated)
        required: true
        type: string
      flood-version:
        description: Flood version used for local tag only
        required: false
        default: dev
        type: string
      flood-repository:
        description: Repository path for flood image
        required: false
        default: jesec/flood
        type: string
      build-rtorrent:
        description: Whether to build rtorrent-flood distroless image
        required: false
        default: true
        type: boolean
      rtorrent-tags:
        description: Docker tags for the rtorrent-flood distroless image (newline separated)
        required: false
        default: jesec/rtorrent-flood:dev-distroless
        type: string
      rtorrent-version:
        description: rtorrent version used for local tag only
        required: false
        default: master
        type: string
      rtorrent-image:
        description: Full image reference for rtorrent base
        required: false
        default: docker.io/jesec/rtorrent:master
        type: string

jobs:
  docker:
    runs-on: ubuntu-24.04
    env:
      LOCAL_REGISTRY: 127.0.0.1:5000

    services:
      registry:
        image: registry:2
        ports:
          - 5000:5000
        options: >-
          --name ci-registry

    steps:
      - uses: actions/checkout@v4

      - name: Download pkg binaries artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs['binary-artifact'] }}
          path: artifacts

      - name: Compute local image tags
        id: local
        run: |
          printf 'flood=%s\n' "${LOCAL_REGISTRY}/${{ inputs['flood-repository'] }}:${{ inputs['flood-version'] }}-distroless" >> "$GITHUB_OUTPUT"
          printf 'rtorrent=%s\n' "${LOCAL_REGISTRY}/rtorrent-flood:${{ inputs['rtorrent-version'] }}-distroless" >> "$GITHUB_OUTPUT"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host

      - name: Login to Docker Hub
        if: inputs.push
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GHCR
        if: inputs.push
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install regctl
        if: inputs.push
        uses: regclient/actions/regctl-installer@v0.1.0

      - name: Configure regctl for local registry
        if: inputs.push
        run: regctl registry set --tls disabled "${LOCAL_REGISTRY}"

      - name: Build flood distroless image
        id: build_flood
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./distribution/containers/Dockerfile.distroless
          target: flood
          platforms: ${{ inputs.platforms }}
          push: true
          pull: false
          tags: ${{ steps.local.outputs.flood }}

      - name: Mirror flood distroless image to targets
        if: inputs.push
        env:
          LOCAL_TAG: ${{ steps.local.outputs.flood }}
        run: |
          while IFS= read -r tag; do
            [ -z "$tag" ] && continue
            regctl image copy "$LOCAL_TAG" "$tag"
          done <<< "${{ inputs['flood-tags'] }}"

      - name: Build rtorrent-flood distroless image
        if: inputs.build-rtorrent
        id: build_rtorrent
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./distribution/containers/Dockerfile.distroless
          target: rtorrent-flood
          platforms: ${{ inputs.platforms }}
          push: true
          pull: false
          tags: ${{ steps.local.outputs.rtorrent }}
          build-args: |
            RTORRENT_IMAGE=${{ inputs['rtorrent-image'] }}

      - name: Mirror rtorrent-flood distroless image to targets
        if: inputs.push && inputs.build-rtorrent
        env:
          LOCAL_TAG: ${{ steps.local.outputs.rtorrent }}
        run: |
          while IFS= read -r tag; do
            [ -z "$tag" ] && continue
            regctl image copy "$LOCAL_TAG" "$tag"
          done <<< "${{ inputs['rtorrent-tags'] }}"
