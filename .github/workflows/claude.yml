name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  guard:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
    outputs:
      should_run: ${{ steps.evaluate.outputs.should_run }}
    steps:
      - name: Evaluate trigger source
        id: evaluate
        uses: actions/github-script@v7
        with:
          script: |
            const repoFullName = `${context.repo.owner}/${context.repo.repo}`;
            const eventName = context.eventName;

            let tagged = false;
            let isExternal = false;

            if (eventName === 'issue_comment') {
              const body = context.payload.comment?.body ?? '';
              tagged = body.includes('@claude');

              if (context.payload.issue?.pull_request) {
                const prNumber = context.payload.issue.number;
                const {data: pr} = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                });

                isExternal = pr.head.repo.full_name !== repoFullName;
              }
            } else if (eventName === 'pull_request_review_comment') {
              const body = context.payload.comment?.body ?? '';
              tagged = body.includes('@claude');
              isExternal = (context.payload.pull_request?.head?.repo?.full_name ?? repoFullName) !== repoFullName;
            } else if (eventName === 'pull_request_review') {
              const body = context.payload.review?.body ?? '';
              tagged = body.includes('@claude');
              isExternal = (context.payload.pull_request?.head?.repo?.full_name ?? repoFullName) !== repoFullName;
            } else if (eventName === 'issues') {
              const issueBody = context.payload.issue?.body ?? '';
              const issueTitle = context.payload.issue?.title ?? '';
              tagged = issueBody.includes('@claude') || issueTitle.includes('@claude');
            }

            core.setOutput('should_run', String(tagged && !isExternal));

  claude:
    needs: guard
    if: needs.guard.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # Optional: Give a custom prompt to Claude. If this is not specified, Claude will perform the instructions specified in the comment that tagged it.
          # prompt: 'Update the pull request description to include a summary of changes.'

          # Optional: Add claude_args to customize behavior and configuration
          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/cli-reference for available options
          # claude_args: '--allowed-tools Bash(gh pr:*)'
